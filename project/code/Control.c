#include "Control.h"
#include "motor.h"
#include "servo.h"

volatile float Err;                    // 摄像头误差
extern volatile int Search_Stop_Line;  // 搜索截止行
extern volatile int L_Line[MT9V03X_H]; // 左边线数组
extern volatile int R_Line[MT9V03X_H]; // 右边线数组

// 加权控制
/* const uint8 Weight[MT9V03X_H]=
{
        1, 1, 1, 1, 1, 1, 1, 1, 1, 10,              //图像最远端00 ——09 行权重
        9, 10, 10, 10, 10, 6, 7, 8, 9, 10,          //图像最远端10 ——19 行权重
        1, 10, 8, 7, 7, 8, 2, 3, 4, 5,              //图像最远端20 ——29 行权重
        6, 7, 9,11,13,15,20,22,25,25,              //图像最远端30 ——39 行权重
       20,17,15,13,11, 9, 7, 5, 3, 8,              //图像最远端40 ——49 行权重
        8, 8, 8, 8, 6, 8, 1, 1, 1, 1,              //图像最远端50 ——59 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,              //图像最远端60 ——69 行权重

}; */
/* 求误差的加权平均数 */
/* const uint8 Weight[MT9V03X_H]=
{
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,              //图像最远端00 ——09 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 10, 10,            //图像最远端10 ——19 行权重
        10, 10, 10, 10, 10, 10, 10, 3, 4, 5,       //图像最远端20 ——29 行权重
        6, 7, 9,11,13,15,17,19,20,20,              //图像最远端30 ——39 行权重
       19,17,15,13,11, 9, 7, 5, 3, 1,              //图像最远端40 ——49 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,              //图像最远端50 ——59 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,              //图像最远端60 ——69 行权重

};
 */

/* const float Weight[MT9V03X_H]=
{
       0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1,              //图像最远端00 ——09 行权重
       0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1,              //图像最远端10 ——19 行权重
       0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1,              //图像最远端20 ——29 行权重
       0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1,             //图像最远端30 ——39 行权重
       6, 7, 9,11,13,15,17,19,20,20,              //图像最远端40 ——49 行权重
       0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1,              //图像最远端50 ——59 行权重
       0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1,              //图像最远端60 ——69 行权重
}; */

// 加权控制 1111111111
/* const float Weight[MT9V03X_H]=
{
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,              //图像最远端00 ——09 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,              //图像最远端10 ——19 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 3, 4, 5,
        6, 7, 9,11,13,15,17,19,20,20,
       19,17,15,13,11, 9, 7, 5, 3, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
}; */

// 加权控制   2222222
/* const float Weight[MT9V03X_H] =
    {
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 图像最远端00 ——09 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 图像最远端10 ——19 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 2, 3, 6, 7, 8, 8,
        7, 7, 8,9, 9,
        9, 11, 11, 11, 13, 15, 17, 19, 20, 20,
        19, 17, 15, 13, 11, 10, 10, 7, 7, 7,
        7, 6, 6, 6, 6, 5, 5, 5, 5, 4,
        4, 4, 3, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1}; */

/* const float Weight[MT9V03X_H] =
    {
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 图像最远端00 ——09 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 图像最远端10 ——19 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 2, 3, 6, 7, 8, 8,
        7, 7, 8,9, 9,
        9, 11, 11, 11, 13, 15, 17, 19, 20, 20,
        19, 17, 15, 13, 11, 10, 10, 7, 7, 7,
        7, 6, 6, 6, 6, 5, 5, 5, 5, 4,
        4, 4, 3, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1}; */

const float Weight[MT9V03X_H] =
    {
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 图像最远端00 ——09 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 图像最远端10 ——19 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 2, 3, 6, 7, 8, 8,
        7, 10, 10, 10, 10,
        10, 11, 11, 11, 13, 15, 17, 19, 20, 20,
        19, 17, 15, 13, 11, 10, 10, 8, 8, 8,
        8, 8, 8, 8, 8, 8, 8, 8, 8, 8,
        7, 7, 7, 7, 7, 7, 5, 4, 3, 2,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1};

/* const float Weight[MT9V03X_H] =
    {
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 图像最远端00 ——09 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 图像最远端10 ——19 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        2, 3, 6, 8, 8, 8,
        8, 8, 8,9, 9,
        9, 11, 11, 11, 20, 20, 20, 20, 20, 20,
        19, 17, 15, 13, 11, 10, 10, 7, 7, 7,
        7, 6, 6, 6, 6, 5, 5, 5, 5, 4,
        4, 4, 3, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1,1,1,1,1};

 */
/* const float Weight[MT9V03X_H]=
{
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,              //图像最远端00 ——09 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,              //图像最远端10 ——19 行权重
        3, 4, 5,              //图像最远端20 ——29 行权重
        6, 7, 9,11,13,15,17,19,20,20,              //图像最远端30 ——39 行权重
        19,17,15,13,11, 9, 7, 5, 3, 1,
        1,1,1,1,1,1,1,                                  //图像最远端40 ——49 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,              //图像最远端50 ——59 行权重
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,              //图像最远端60 ——69 行权重

}; */

void Err_Sum(void)
{
    int i;
    float sum          = 0;
    float weight_count = 0;
    // 常规误差
    for (i = MT9V03X_H - 1; i >= MT9V03X_H - Search_Stop_Line - 1; i--) // 常规误差计算
    {
        sum += (MT9V03X_W / 2 - ((L_Line[i] + R_Line[i]) >> 1)) * Weight[i]; // 右移1位，等效除2
        weight_count += Weight[i];
    }
    Err = sum / weight_count;
    /* for (i = MT9V03X_H - 1; i >= MT9V03X_H - Search_Stop_Line - 1; i--) // 常规误差计算
    {
        Err += (MT9V03X_W / 2 - ((L_Line[i] + R_Line[i]) / 2.0)); // 右移1位，等效除2
    }
    Err = Err / 70; */
}
